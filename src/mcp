#!/usr/bin/php
<?
$fifo_path="/tmp/mcp.fifo";

function mcp_process($todo) {
  print "$todo\n";
  return 1;
}

declare(ticks=1);
function mcp_sig_handler($signo) {
  global $fifo;
  global $fifo_path;

  switch($signo) {
    case SIGTERM:
    case SIGINT:
      print "exiting\n";
      fclose($fifo);
      unlink($fifo_path);
      exit;
  }
}

posix_mkfifo($fifo_path, 0666);
$fifo=fopen($fifo_path, "r+");

pcntl_signal(SIGTERM, "mcp_sig_handler");
pcntl_signal(SIGINT,  "mcp_sig_handler");

while(1) {
  $stream_read=array($fifo);
  $stream_write=array();
  $stream_except=array();
  stream_select($stream_read, $stream_write, $stream_except, 1);

  foreach($stream_read as $str) {
    if($str==$fifo) {
      $todo=trim(fgets($fifo));
      mcp_process($todo);
    }
  }
}
